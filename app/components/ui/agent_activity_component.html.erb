<div data-controller="agent-activity">
  <div class="grid gap-3 md:grid-cols-2 lg:grid-cols-4 mb-6">
    <% @agents.each do |agent| %>
      <% badge = agent_status_badge(agent[:enabled]) %>
      <div
        class="rounded-xl border border-neutral-800 bg-neutral-950/60 px-4 py-3"
        data-agent-key="<%= agent[:name] %>"
        data-agent-enabled="<%= agent[:enabled] ? "true" : "false" %>"
      >
        <div class="flex items-center justify-between">
          <div class="text-xs text-neutral-400 uppercase tracking-wider"><%= agent[:name].titleize %></div>
          <span class="text-[10px] px-2 py-0.5 rounded-full border <%= badge[:classes] %>" data-agent-role="badge">
            <%= badge[:text] %>
          </span>
        </div>

        <div class="mt-2 text-xs text-neutral-500 line-clamp-2"><%= agent[:description] %></div>
        <div class="mt-3 flex items-center justify-between gap-2">
          <span class="text-xs text-neutral-600" data-agent-role="runs"><%= agent[:recent_executions] %> runs today</span>

          <div class="flex items-center gap-2">
            <button
              type="button"
              data-action="click->agent-activity#toggleAgent"
              data-agent-name="<%= agent[:name] %>"
              data-agent-role="toggle"
              data-enabled="<%= agent[:enabled] ? "true" : "false" %>"
              class="<%= toggle_button_classes(agent[:enabled]) %>"
            >
              <%= toggle_button_label(agent[:enabled]) %>
            </button>

            <button
              data-action="click->agent-activity#triggerAgent"
              data-agent-name="<%= agent[:name] %>"
              data-agent-role="run"
              data-enabled="<%= agent[:enabled] ? "true" : "false" %>"
              class="<%= run_button_classes(agent[:enabled]) %>"
              <%= agent[:enabled] ? "" : "disabled" %>
            >
              <%= run_button_label(agent[:enabled]) %>
            </button>
          </div>
        </div>

        <% if agent[:name] == "chaos_orchestrator" %>
          <div
            class="mt-2 text-xs text-neutral-600"
            data-agent-role="chaos-hint"
            style="<%= agent[:enabled] ? "display:none;" : "" %>"
          >
            Disabled by default for safety. Enable to schedule chaos drills.
          </div>
        <% end %>
      </div>
    <% end %>
  </div>

  <div class="rounded-xl border border-neutral-800 bg-neutral-950/40">
    <div class="px-4 py-3 border-b border-neutral-800 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <div class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div>
        <span class="text-sm font-medium">Live Agent Activity</span>
      </div>
      <button
        type="button"
        data-action="click->agent-activity#refresh"
        class="<%= refresh_button_classes %>"
      >
        <%= heroicon("arrow-path", classes: "w-3 h-3") %>
        <span>Refresh</span>
      </button>
    </div>

    <div data-agent-activity-target="feed" class="max-h-64 overflow-y-auto">
      <% if @recent_activity.any? %>
        <div class="divide-y divide-neutral-800">
          <% @recent_activity.each do |activity| %>
            <div class="px-4 py-3 flex items-start gap-3 hover:bg-neutral-900/50 transition-colors">
              <span class="<%= execution_status_color(activity[:status]) %>">
                <%= execution_status_icon(activity[:status]) %>
              </span>
              <div class="flex-1 min-w-0">
                <div class="flex items-center gap-2">
                  <span class="text-sm font-medium text-neutral-200"><%= activity[:agent].titleize %></span>
                  <% if activity[:shard] %>
                    <span class="text-xs text-neutral-500"><%= activity[:shard] %></span>
                  <% end %>
                </div>
                <% if activity[:action].present? %>
                  <div class="text-xs text-neutral-400 mt-0.5"><%= activity[:action].to_s.humanize %></div>
                <% end %>
                <% if activity[:description].present? %>
                  <div class="text-xs text-neutral-500 mt-1 line-clamp-1"><%= activity[:description] %></div>
                <% end %>
              </div>
              <div class="text-xs text-neutral-600 whitespace-nowrap">
                <%= format_time_ago(activity[:created_at]) %>
              </div>
            </div>
          <% end %>
        </div>
      <% else %>
        <div class="px-4 py-8 text-center">
          <div class="text-sm text-neutral-500">No agent activity yet</div>
          <div class="text-xs text-neutral-600 mt-1">Agents will appear here when they run</div>
        </div>
      <% end %>
    </div>
  </div>

  <div class="mt-4 rounded-xl border border-neutral-800 bg-neutral-950/40">
    <details class="group">
      <summary class="px-4 py-3 cursor-pointer list-none flex items-center justify-between hover:bg-neutral-900/30">
        <span class="text-sm font-medium">Agent Capabilities</span>
        <span class="text-neutral-500 group-open:rotate-180 transition-transform">
          <%= heroicon("chevron-down", classes: "w-4 h-4") %>
        </span>
      </summary>
      <div class="px-4 py-3 border-t border-neutral-800 text-sm text-neutral-400 space-y-2">
        <div class="flex gap-2">
          <span class="text-emerald-400 font-medium">BudgetGuard</span>
          <span>Predicts budget exhaustion and warns before release risk.</span>
        </div>
        <div class="flex gap-2">
          <span class="text-emerald-400 font-medium">ChaosOrchestrator</span>
          <span>Schedules controlled failure drills when safety checks pass.</span>
        </div>
        <div class="flex gap-2">
          <span class="text-emerald-400 font-medium">IncidentResponse</span>
          <span>Analyzes incident context and suggests runbooks.</span>
        </div>
        <div class="flex gap-2">
          <span class="text-emerald-400 font-medium">Healing</span>
          <span>Applies low-risk recovery actions with auditability.</span>
        </div>
      </div>
    </details>
  </div>
</div>
